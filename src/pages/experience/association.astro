---
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

import Layout from "../../layouts/Layout.astro";
import "../../styles/associations.css";

const slidesDirectory = fileURLToPath(new URL("../../../public/assos/amma-slides", import.meta.url));
const allowedSlideExtensions = new Set([".png", ".jpg", ".jpeg", ".gif", ".webp", ".heic", ".heif"]);
const collator = new Intl.Collator("fr", { sensitivity: "base" });

const toAltText = (filename: string) => {
  const withoutExt = filename.replace(/\.[^.]+$/, "");
  const cleaned = withoutExt.replace(/[_-]+/g, " ").replace(/\s+/g, " ").trim();
  if (!cleaned) return "Visuel AMMA";
  return `Visuel AMMA — ${cleaned}`;
};

const ammaSlideImages = fs
  .readdirSync(slidesDirectory)
  .filter((file) => allowedSlideExtensions.has(path.extname(file).toLowerCase()))
  .sort((a, b) => collator.compare(a, b))
  .map((file, index) => ({
    type: "image" as const,
    src: `/assos/amma-slides/${file}`,
    alt: toAltText(file),
    id: `amma-image-${index}`
  }));

const ammaYoutubeVideos = [
  {
    type: "video" as const,
    title: "AMMA - Session de démonstration",
    embedUrl: "https://www.youtube.com/embed/_njkeV-2ZI8",
    description: "Moments forts d'une session d'entraînement AMMA.",
    id: "amma-video-demo"
  },
  {
    type: "video" as const,
    title: "AMMA - Sparring Highlights",
    embedUrl: "https://www.youtube.com/embed/l5ePZ_1x9i8",
    description: "Retour sur les sparrings majeurs de la saison.",
    id: "amma-video-sparring"
  }
];

const ammaMediaItems = [...ammaSlideImages, ...ammaYoutubeVideos];
const marqueeItems = [...ammaMediaItems, ...ammaMediaItems];
---

<Layout title="Associations" description="Association involvements and roles.">
  <!-- Gestion background -->
  <div class="page-bg">
    <!-- Section 0 : intro, full image -->
    <div
      class="page-bg-layer asso-bg-full"
      style="--asso-image: url('/assos/assos.jpg');"
      data-bg="0"
    ></div>

    <!-- Section 1 : ADA, timeline à gauche → image à gauche -->
    <div
      class="page-bg-layer asso-bg-left"
      style="
        --asso-image: url('/assos/galada.JPG');
        --asso-color: #9F1B37;
      "
      data-bg="1"
    ></div>

    <!-- Section 2 : AMMA, timeline à droite → image à droite,
        et on décale l’image (ex : 80% vers la droite) -->
    <div
      class="page-bg-layer asso-bg-right"
      style="
        --asso-image: url('/assos/amma.jpg');
        --asso-color: #000000;
      "
      data-bg="2"
    ></div>

    <!-- Tu adapteras les suivantes quand tu auras les images définitives -->
    <div
      class="page-bg-layer asso-bg-left"
      style="
        --asso-image: url('/assos/joute.JPG');
        --asso-color: #56377c;
      "
      data-bg="3"
    ></div>

    <div
      class="page-bg-layer asso-bg-right"
      style="
        --asso-image: url('/assos/dvb.png');
        --asso-color: #0a1370;
      "
      data-bg="4"
    ></div>

    <div
      class="page-bg-layer asso-bg-left"
      style="
      --asso-image: url('/assos/leotalks-2.png');  
        --asso-color: #1d0102;
      "
      data-bg="5"
    ></div>

    <div
      class="page-bg-layer asso-bg-right"
      style="
        --asso-image: url('/assos/comedia-2.png');
        --asso-color: #95282e;
      "
      data-bg="6"
    ></div>

    <div
      class="page-bg-layer asso-bg-left"
      style="
        --asso-image: url('/assos/lpdv-2.png');
        --asso-color: #FAF8EB;
      "
      data-bg="7"
    ></div>
  </div>



  <!-- Section 1 -->
  <section class="bg-part" data-bg="0">
    <h1>Associations</h1>
    <p>Au cours de ma scolarité, j'ai fait partie de différentes associations étudiantes, cherchant à diversifier
      un maximum les expériences et les apprentissages, tout en apportant mon énergie, ma créativité et mon sens de
      l'organisation. J'ai occupé des rôles très divers d'une association à l'autre.
    </p>
  </section>

  <section class="bg-part bg-part--align-left" data-bg="1">
    <div class="asso-heading">
      <h2>ADA – Aider Donner Agir</h2>
      <img src="/assos/logo-ada.png" alt="Logo ADA" class="asso-logo">
    </div>
    <div
      class="asso asso--timeline-left"
    >
      <div class="asso-main">
        <!-- Colonne timeline -->
        <ul class="roles-timeline">
          <li>
            <span class="role-title">Membre</span>
            <span class="role-meta">2025 – </span>
          </li>
          <li>
            <span class="role-title">Vice-Président</span>
            <span class="role-meta">2024 – 2025</span>
          </li>
          <li>
            <span class="role-title">Membre</span>
            <span class="role-meta">2023 – 2024</span>
          </li>
        </ul>

        <!-- Colonne contenu -->
        <div class="asso-content">
          <p>ADA est l'association caritative du Pôle Léonard de Vinci, comptant près de 150 membres. Ses missions s'organisent
            autour de 4 axes : la précarité, l'enfance, le handicap et la maladie.<br/>
            J'ai participé à de nombreuses actions, des distributions alimentaires, des évènements de sensibilisation, des
            récoltes de fonds, dès ma première année. Cet investissement m'a permis d'accéder en 2024 à la vice-présidene de
            l'association, que j'ai assurée pendant un an.<br/>
            Dans mon rôle de vice-président, j'ai participé à coordonner toutes les activités de l'association, les actions
            régulières comme les projets majeurs : l'organisation d'un mois de collecte pour Octobre Rose, ou le Gala de
            l'association, organisé avec un budget de 1 400 €, nous ayant permis de récolter 5 400 € à reverser à nos
            associations partenaires.<br/>
            
          </p>
        </div>
      </div>

      <!-- Bas de bloc (texte ou images en plus) -->
      <div class="asso-extra">
        <p>Texte complémentaire, anecdotes, photos, actions marquantes…</p>
      </div>
    </div>
  </section>

  <section class="bg-part bg-part--align-right" data-bg="2">
    <div class="asso-heading">
      <h2>AMMA — Association for Mixed Martial Arts</h2>
      <img src="/assos/logo-amma.png" alt="Logo AMMA" class="asso-logo">
    </div>
      <div
        class="asso asso--timeline-right"
      >
      <div class="asso-main">
        <ul class="roles-timeline">
          <li>
            <span class="role-title">Membre</span>
            <span class="role-meta">2025 – </span>
          </li>
          <li>
            <span class="role-title">Responsable communication</span>
            <span class="role-meta">2024 – 2025</span>
          </li>
          <li>
            <span class="role-title"> Membre </span>
            <span class="role-meta">2023 – 2024</span>
          </li>
        </ul>

        <div class="asso-content">
          <p>…</p>
        </div>
      </div>

      </div>
    </div>
  </section>

  <div class="asso-extra asso-extra--full-bleed">
    <div class="asso-media-marquee" aria-label="Galerie des actions AMMA" data-media-slider>
      <button
        type="button"
        class="asso-media-control asso-media-control--prev"
        data-media-control="prev"
        aria-label="Voir les visuels précédents"
      >
        <span class="visually-hidden">Voir les visuels précédents</span>
      </button>
      <div class="asso-media-track-wrapper">
        <div class="asso-media-track" data-media-track>
          {marqueeItems.map((item, index) => (
            <div
              class={`asso-media-card ${item.type === "video" ? "asso-media-card--video" : ""}`}
              data-type={item.type}
              aria-hidden={index >= ammaMediaItems.length ? "true" : undefined}
            >
              {item.type === "image" ? (
                <img src={item.src} alt={item.alt} loading="lazy" decoding="async" />
              ) : (
                <div class="asso-media-video">
                  <iframe
                    src={item.embedUrl}
                    title={item.title}
                    loading="lazy"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen
                  ></iframe>
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
      <button
        type="button"
        class="asso-media-control asso-media-control--next"
        data-media-control="next"
        aria-label="Voir les visuels suivants"
      >
        <span class="visually-hidden">Voir les visuels suivants</span>
      </button>
    </div>
    <p class="asso-media-hint">
      Le bandeau défile en continu&nbsp;— survolez ou touchez pour le mettre en pause et explorer chaque visuel.
    </p>
  </div>

  <section class="bg-part bg-part--align-left" data-bg="3">
    <div class="asso-heading">
      <h2>La Joute de Vinci</h2>
      <img src="/assos/ljdv-logo.png" alt="Logo Joute de Vinci" class="asso-logo">
    </div>
    <div
      class="asso asso--timeline-left"
    >
      <div class="asso-main">
        <!-- Colonne timeline -->
        <ul class="roles-timeline">
          <li>
            <span class="role-title">Membre – Bureau Étendu</span>
            <span class="role-meta">2022 – </span>
          </li>
          <li>
            <span class="role-title">Membre</span>
            <span class="role-meta">2021 – 2022</span>
          </li>
        </ul>

        <!-- Colonne contenu -->
        <div class="asso-content">
          <p>Résumé rapide de l’association, objectifs, missions, ce que tu y as appris…</p>
        </div>
      </div>

      <!-- Bas de bloc (texte ou images en plus) -->
      <div class="asso-extra">
        <p>Texte complémentaire, anecdotes, photos, actions marquantes…</p>
      </div>
    </div>
  </section>

  <section class="bg-part bg-part--align-right" data-bg="4">
    <h2>DaVinciBot</h2>
      <div
        class="asso asso--timeline-right"
      >
      <div class="asso-main">
        <ul class="roles-timeline">
          <li>
            <span class="role-title">Membre Projet – JASPER</span>
            <span class="role-meta">2022 – 2023</span>
          </li>
        </ul>

        <div class="asso-content">
          <p>…</p>
        </div>
      </div>

      <div class="asso-extra">
        <p>Texte ou images supplémentaires pour DVB.</p>
      </div>
    </div>
  </section>

  <section class="bg-part bg-part--align-left" data-bg="5">
    <h2>LeoTalks</h2>
    <div
      class="asso asso--timeline-left"
    >
      <div class="asso-main">
        <!-- Colonne timeline -->
        <ul class="roles-timeline">
          <li>
            <span class="role-title">Responsable Partenariats</span>
            <span class="role-meta">2023 – 2024</span>
          </li>
          <li>
            <span class="role-title">Membre</span>
            <span class="role-meta">2022 – 2023</span>
          </li>
        </ul>

        <!-- Colonne contenu -->
        <div class="asso-content">
          <p>Résumé rapide de l’association, objectifs, missions, ce que tu y as appris…</p>
        </div>
      </div>

      <!-- Bas de bloc (texte ou images en plus) -->
      <div class="asso-extra">
        <p>Texte complémentaire, anecdotes, photos, actions marquantes…</p>
      </div>
    </div>
  </section>

  <section class="bg-part bg-part--align-right bg-part--full-bleed" data-bg="6">
    <div class="asso-heading">
      <h2>Comedia da Vinci</h2>
      <img src="/assos/comedia-logo.png" alt="Logo Comedia de Vinci" class="asso-logo">
    </div>
      <div
        class="asso asso--timeline-right"
      >
      <div class="asso-main">
        <ul class="roles-timeline">
          <li>
            <span class="role-title">Responsable des évènements</span>
            <span class="role-meta">2022 – 2023</span>
          </li>
          <li>
            <span class="role-title"> Membre </span>
            <span class="role-meta">2022</span>
          </li>
        </ul>

        <div class="asso-content">
          <p>…</p>
        </div>
      </div>

      <div class="asso-extra">
        <p>Texte ou images supplémentaires pour Comedia.</p>
      </div>
    </div>
  </section>

  <section class="bg-part bg-part--align-left" data-bg="7">
    <div class="asso-heading">
      <h2>La Plume de Vinci</h2>
      <img src="/assos/la-plume-vinci-logo.jpeg" alt="Logo Plume de Vinci" class="asso-logo">
    </div>
    <div
      class="asso asso--timeline-left"
    >
      <div class="asso-main">
        <!-- Colonne timeline -->
        <ul class="roles-timeline">
          <li>
            <span class="role-title">Écrivain - Philosophie Politique & Imagination</span>
            <span class="role-meta">2022 –</span>
          </li>
          <li>
            <span class="role-title">Membre</span>
            <span class="role-meta">2021 – 2022</span>
          </li>
        </ul>

        <!-- Colonne contenu -->
        <div class="asso-content">
          <p>Résumé rapide de l’association, objectifs, missions, ce que tu y as appris…</p>
        </div>
      </div>

      <!-- Bas de bloc (texte ou images en plus) -->
      <div class="asso-extra">
        <p>Texte complémentaire, anecdotes, photos, actions marquantes…</p>
      </div>
    </div>
  </section>

  <div id="assoMediaOverlay" class="asso-media-overlay" aria-hidden="true">
    <figure>
      <button type="button" class="asso-media-overlay__close" data-overlay-close aria-label="Fermer l'aperçu">
        ×
      </button>
      <img src="" alt="" />
      <figcaption class="asso-media-overlay__caption"></figcaption>
    </figure>
  </div>

  <script type="module">
    const scrollStep = 320;
    const autoScrollSpeed = 0.6;
    const sliders = document.querySelectorAll("[data-media-slider]");
    sliders.forEach((slider) => {
      const track = slider.querySelector("[data-media-track]");
      if (!track) {
        return;
      }

      const getLoopWidth = () => track.scrollWidth / 2;

      const normalizeForward = () => {
        const loopWidth = getLoopWidth();
        if (loopWidth > 0 && track.scrollLeft >= loopWidth) {
          track.scrollLeft -= loopWidth;
        }
      };

      const normalizeBackward = () => {
        const loopWidth = getLoopWidth();
        if (loopWidth > 0 && track.scrollLeft < 0) {
          track.scrollLeft += loopWidth;
        }
      };

      const scrollByStep = (direction) => {
        const loopWidth = getLoopWidth();
        if (direction === -1 && loopWidth > 0 && track.scrollLeft <= 0) {
          track.scrollLeft += loopWidth;
        }
        normalizeBackward();
        track.scrollLeft += direction * scrollStep;
        normalizeForward();
      };

      let animationId = null;
      let restartTimeout = null;
      const autoStep = () => {
        track.scrollLeft += autoScrollSpeed;
        normalizeForward();
        animationId = requestAnimationFrame(autoStep);
      };
      const startAuto = () => {
        if (animationId === null) {
          animationId = requestAnimationFrame(autoStep);
        }
      };
      const stopAuto = () => {
        if (animationId !== null) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        if (restartTimeout !== null) {
          clearTimeout(restartTimeout);
          restartTimeout = null;
        }
      };

      startAuto();

      slider.querySelectorAll("[data-media-control]").forEach((button) => {
        button.addEventListener("click", () => {
          const direction = button.dataset.mediaControl === "next" ? 1 : -1;
          stopAuto();
          scrollByStep(direction);
          restartTimeout = window.setTimeout(startAuto, 1500);
        });
      });

      slider.addEventListener("mouseenter", stopAuto);
      slider.addEventListener("mouseleave", startAuto);
      slider.addEventListener("focusin", stopAuto);
      slider.addEventListener("focusout", startAuto);
    });

    const overlay = document.getElementById("assoMediaOverlay");
    if (overlay) {
      const overlayImg = overlay.querySelector("img");
      const overlayCaption = overlay.querySelector(".asso-media-overlay__caption");

      const openOverlay = (src, alt) => {
        if (!overlayImg) {
          return;
        }
        overlayImg.src = src;
        overlayImg.alt = alt;
        if (overlayCaption) {
          overlayCaption.textContent = alt;
        }
        overlay.classList.add("is-visible");
        overlay.setAttribute("aria-hidden", "false");
      };

      const closeOverlay = () => {
        overlay.classList.remove("is-visible");
        overlay.setAttribute("aria-hidden", "true");
      };

      overlay.querySelectorAll("[data-overlay-close]").forEach((closeEl) => {
        closeEl.addEventListener("click", closeOverlay);
      });
      overlay.addEventListener("click", (event) => {
        if (event.target === overlay) {
          closeOverlay();
        }
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeOverlay();
        }
      });

      document.querySelectorAll(".asso-media-card[data-type=\"image\"] img").forEach((img) => {
        img.addEventListener("click", () => {
          openOverlay(img.src, img.alt);
        });
      });
    }
  </script>
</Layout>
